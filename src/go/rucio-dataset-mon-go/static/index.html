<!DOCTYPE html>
<html lang="en">
<head>
    <title> Go Datatable (Serverside) </title>
    <meta content="width=device-width, initial-scale=1" name="viewport">
    <!-- prepared using https://datatables.net/download/ -->
    <link
        href="https://cdn.datatables.net/v/bs5/jq-3.6.0/jszip-2.5.0/dt-1.12.1/b-2.2.3/b-colvis-2.2.3/b-html5-2.2.3/b-print-2.2.3/date-1.1.2/fc-4.1.0/fh-3.2.4/r-2.3.0/sc-2.0.7/sb-1.3.4/sp-2.0.2/sl-1.4.0/sr-1.1.1/datatables.min.css"
        rel="stylesheet"
        type="text/css"/>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/5.1.3/css/bootstrap.min.css" rel="stylesheet"
          type="text/css"/>
    <link href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.1/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-select/1.13.1/css/bootstrap-select.css"
          rel="stylesheet"/>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.0/css/bootstrap.min.css">

    <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.1/jquery.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.1.1/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-select/1.13.1/js/bootstrap-select.min.js"></script>

    <!--  Please do not delete below CSSes, important for pretty view -->
    <style>
        table td {
            font-size: small;
        }

        /* Type, Dataset, RSE, Tier, C, RseKind */
        table tr td:nth-child(n+1):nth-child(-n+4) {
            text-align: left;
        }

        /* SizeBytes, LastAcc, LastAccMs, Fpct, Fcnt, TotFcnt, AccFcnt, ProdLckCnt, OthLckCnt */
        table tr td:nth-child(n+5):nth-child(-n+9) {
            text-align: right;
        }

        /*  */
        .table > tbody > tr > td.rse-details-style {
            color: #DC3220;
        !important;
        }

        /*.go-datatable > tbody > tr:nth-child(odd) > td,*/
        /*.go-datatable > tbody > tr:nth-child(odd) > th {*/
        /*    background-color: #F9ECEC;*/
        /*}*/

        .custom-input {
            /*height: 30px !important;*/
            /*max-height: 30px !important;*/
            /*background-color: gold;*/
        }

        .custom-filters {
            /*background-color: lightslategray;*/
            font-weight: bolder;
        }

        #timestamp-hover-button:hover {
            border-color: #005AB5;
            border-block-start-width: thick;
            /*background-color: ;*/
        }

        /*Hover text for timestamp*/
        .tooltip > .tooltip-inner {
            background-color: white;
            color: black;
            font-family: 'Trebuchet MS', sans-serif;
            font-size: small;
        }

    </style>
</head>
<body>

<div class="container-fluid no-padding" style="width: 100%">
    <div class="row" style="background-color: #ECF2F9">
        <div class="col-xs-6 col-sm-4">
            <footer>
                <img alt="CERN CMS O&C" src="../static/img/oc_icon.png"
                     width="60"          height="40">
            </footer>
        </div>
        <div class="col-xs-6 col-sm-4 align-self-center">
            <h3> RUCIO DATASETS MONITORING </h3>
        </div>
        <div class="col-xs-6 col-sm-4 text-right">
            <footer>
                <img alt="CERN CMS O&C" src="../static/img/oc_icon.png" style="text-align: right;"
                     width="60"          height="40">
            </footer>
        </div>
    </div>
</div>

<div class="container-fluid no-padding" style="width: 96%; background-color: #F9F9F9">
    <div class="row">
        <hr class="rounded">
    </div>

    <div class="row custom-filters">
        <div class="col">
            <select class="selectpicker custom-input" id="select-rse-type" multiple title="RSE Type">
                <option value="DISK">DISK</option>
                <option value="TAPE">TAPE</option>
            </select>
        </div>
        <div class="col">
            <input class="form-control input-sm custom-input" id="search-dataset" placeholder="Dataset" type="search"/>
        </div>
        <div class="col">
            <input class="form-control input-sm custom-input" id="search-rse" placeholder="RSE" type="search"/>
        </div>
        <div class="col">
            <button class="btn btn-primary font-weight-bold" id="button-search" type="button">Search</button>
        </div>
        <div class="col">
            <button id="timestamp-hover-button" type="button" class="glyphicon glyphicon-time btn btn-sm"
                    data-toggle="tooltip" data-placement="bottom"
                    style="color: #DC3220; font-size: medium"
                    title="This table is produced with the data of Rucio and DBS sqoop dumps runs in between 6:30AM-7:15AM CERN time">
                DataTimestamp: {{.data_timestamp}}
            </button>
        </div>
    </div>

    <div class="row justify-content-md-center">
        <hr class="rounded">
    </div>
    <table class="go-datatable table table-sm table-bordered table-hover " style="border:3px solid #F0D9DA;">
        <!-- table table-sm-->
        <thead style="background-color: #C8D9EB; color: black; font-size: medium">
        <tr>
            <th></th>
            <th>Rse Type</th>
            <th>Dataset</th>
            <th>Last Access</th>
            <th>Max</th>
            <th>Min</th>
            <th>Avg</th>
            <th>Sum</th>
            <th>RSEs</th>
        </tr>
        </thead>
        <tfoot hidden>
        <tr>
            <th></th>
            <th>Rse Type</th>
            <th>Dataset</th>
            <th>Last Access</th>
            <th>Max</th>
            <th>Min</th>
            <th>Avg</th>
            <th>Sum</th>
            <th>RSEs</th>
        </tr>
        </tfoot>
    </table>
</div>

<div class="footer" style="bottom: 0px; width: 100%;background-color: #262626;border-top: 1px solid #333;">
    <img src='../static/img/LogoOutline-White.svg' alt='CERN' style="height: 70px;margin: 20px;">
</div>

<!-- prepared using https://datatables.net/download/ -->
<script
    src="https://cdn.datatables.net/v/bs5/jq-3.6.0/jszip-2.5.0/dt-1.12.1/b-2.2.3/b-colvis-2.2.3/b-html5-2.2.3/b-print-2.2.3/date-1.1.2/fc-4.1.0/fh-3.2.4/r-2.3.0/sc-2.0.7/sb-1.3.4/sp-2.0.2/sl-1.4.0/sr-1.1.1/datatables.min.js">
</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/5.1.3/js/bootstrap.bundle.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.36/pdfmake.min.js" type="text/javascript"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.36/vfs_fonts.js" type="text/javascript"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/multiple-select/1.1.0/jquery.multiple.select.min.js"
        type="text/javascript">
</script>

<script>
    // Global variable to catch latest datatables request
    var global_dt_request_holder = null;
    // Define short url will be used or not
    var isShortUrl = ({{.is_short_url}} === "true");
    // holds saved state json string
    var global_saved_state_holder;
    var global_saved_state_setter = null;

    if (isShortUrl === true) {
        // Get saved state from template
        global_saved_state_setter = {{.dt_saved_state}};
        global_saved_state_setter = JSON.stringify(global_saved_state_setter);
    }

    console.log(isShortUrl)

    // Required to show text on hover
    $(function () {
        $('[data-toggle="tooltip"]').tooltip()
    })

    bytesToHumanely = function (input_bytes) {
        if (input_bytes === 0) {
            return "0.00 B";
        }
        var e = Math.floor(Math.log(input_bytes) / Math.log(1024));
        return (input_bytes / Math.pow(1024, e)).toFixed(2) + ' ' + ' KMGTPEZY'.charAt(e) + 'B';
    }

    function copyToClipboard(message) {
        var textArea = document.createElement("textarea");
        textArea.value = message;
        textArea.style.opacity = "0";
        document.body.appendChild(textArea);
        textArea.focus();
        textArea.select();
        try {
            var successful = document.execCommand('copy');
            var msg = successful ? 'successful' : 'unsuccessful';
            alert('Copying successful:' + message);
        } catch (err) {
            alert('Unable to copy value , error : ' + err.message);
        }
        document.body.removeChild(textArea);
    }

    // Get short url hash id by sending current page's datatables request and saved state objects
    function getShortUrl() {
        $.ajax({
            url: '../api/short-url',
            type: 'post',
            contentType: 'application/json',
            data: JSON.stringify({
                "dt_request": JSON.parse(global_dt_request_holder),
                "saved_state": JSON.parse(global_saved_state_holder),
            }),
            success: function(data) {
                // Call copy clipboard here
                origin = window.location.origin
                copyToClipboard(origin + '/short-url/' + data);
            },
            error: function() {
                alert('Copy failed');
            }
        });
    }

    $(document).ready(function () {
        function showRseDetails() {
            var tr = $(this).closest("tr");
            dataset_name = $(tr).find("td.details-value-dataset").text()
            type_name = $(tr).find("td.details-value-type").text()
            random_str = Math.random().toString(36).slice(-10)
            d_class = "details-show"
            row = table.row(tr)
            if (!row.child.isShown()) {
                default_bg_color = $(tr).css("background-color");
                $(tr).addClass(d_class)
                $(tr).css("background-color", "#F9ECEC")
                row.child("<div id='" + type_name + random_str + "'>loading</div>").show()
                var single_dataset_request = {
                    "dataset": dataset_name,
                    "type": type_name
                }
                //console.log(JSON.stringify(single_dataset_request))
                $.ajax({
                    url: '../api/rse-detail',
                    type: 'post',
                    dataType: 'html',
                    contentType: 'application/json',
                    data: JSON.stringify(single_dataset_request),
                    success: function (data) {
                        // just to assign random div id
                        $("#" + type_name + random_str).html(data);
                    },
                });
                tr.addClass('selected-row-color')
            } else {
                $(tr).removeClass(d_class)
                $(tr).css("background-color", default_bg_color)
                row.child.hide()
            }
        }

        var table = $('.go-datatable').DataTable({
            serverSide: true,
            processing: true,
            scrollX: false,
            pageLength: 10,
            order: [], // no initial sorting
            dom: "iBplrt", // no main search ("f"), just individual column search
            //language: {processing: '<i class="fa fa-spinner fa-spin fa-3x fa-fw"></i><span class="sr-only">Loading...</span> '},
            aLengthMenu: [
                [5, 10, 25, 50, 100],
                [5, 10, 25, 50, 100]
            ],

            ajax: {
                url: "../api/datasets",
                method: "POST",
                contentType: 'application/json',
                data: function (d) {
                    // Customize search
                    d.custom = {
                        "dataset": $("#search-dataset").val(),
                        "rse": $("#search-rse").val(),
                        "rseType": $("#select-rse-type").val(),
                    }

                    if (isShortUrl === true) {
                        // Set datatable request from saved short-url request using go template
                        d = {{.dt_request_short_url}}
                        global_dt_request_holder = JSON.stringify(d);
                    }else{
                        global_dt_request_holder = JSON.stringify(d);
                    }

                    return global_dt_request_holder;
                },
                // processData: false,
                dataType: "json",
            },

            columns: [
                {
                    // Details button
                    data: null, className: 'dt-control', orderable: false, defaultContent: '',
                },
                {data: "RseType", className: "details-value-type", name: 'Rse Type'},
                {data: "Dataset", className: "details-value-dataset"},
                {data: "LastAccess"},
                {
                    data: "Max",
                    render: function (data, type, row, meta) {
                        return bytesToHumanely(data);
                    },
                    orderSequence: ["desc", "asc"],
                },
                {
                    data: "Min",
                    render: function (data, type, row, meta) {
                        return bytesToHumanely(data);
                    },
                    orderSequence: ["desc", "asc"],
                },
                {
                    data: "Avg",
                    render: function (data, type, row, meta) {
                        return bytesToHumanely(data);
                    },
                    orderSequence: ["desc", "asc"],
                },
                {
                    data: "Sum",
                    render: function (data, type, row, meta) {
                        return bytesToHumanely(data);
                    },
                    orderSequence: ["desc", "asc"],
                },
                {data: "RSEs", className: "rse-details-style"}
            ],
            buttons: [
                {
                    extend: 'copyHtml5',
                    className: "btn btn-primary",
                    exportOptions: {
                        columns: ':visible'
                    }
                },
                {
                    extend: 'excelHtml5',
                    className: "btn btn-primary",
                    exportOptions: {
                        columns: ':visible'
                    }
                },
                {
                    extend: 'pdfHtml5',
                    className: "btn btn-primary",
                    exportOptions: {
                        columns: ':visible'
                    }
                },
                {
                    extend: 'colvis',
                    className: "btn btn-primary",
                },
                {
                    text: 'Copy state link to clipboard',
                    className: "btn btn-primary",
                    action: function (e, dt, node, config) {
                        getShortUrl();
                        // navigator.clipboard.writeText is not working because of https://developer.mozilla.org/en-US/docs/Web/Security/Secure_Contexts ,golang template
                    }
                },
            ],
            stateSave: true,
            stateSaveCallback: function (settings, data) {
                global_saved_state_holder = JSON.stringify(data)
                console.log(global_saved_state_holder);
            },
            stateLoadCallback: function (settings) {
                return global_saved_state_setter;
            }
        });
        // ~~  --  Custom search draw  -- ~~
        $('#button-search').click(function () {
            table.draw();
        });
        // Add event listener for opening and closing details
        table.on('click', 'td.dt-control', showRseDetails);
    });
</script>
</body>
</html>
