<!DOCTYPE html>
<html lang="en">
<head>
    <title> Go Datatable (Serverside) </title>
    <meta content="width=device-width, initial-scale=1" name="viewport">
    <!-- prepared using https://datatables.net/download/ -->
    <link
        href="https://cdn.datatables.net/v/bs5/jq-3.6.0/jszip-2.5.0/dt-1.12.1/b-2.2.3/b-colvis-2.2.3/b-html5-2.2.3/b-print-2.2.3/date-1.1.2/fc-4.1.0/fh-3.2.4/r-2.3.0/sc-2.0.7/sb-1.3.4/sp-2.0.2/sl-1.4.0/sr-1.1.1/datatables.min.css"
        rel="stylesheet"
        type="text/css"/>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/5.1.3/css/bootstrap.min.css" rel="stylesheet"
          type="text/css"/>
    <link href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.1/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-select/1.13.1/css/bootstrap-select.css"
          rel="stylesheet"/>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.1/jquery.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.1.1/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-select/1.13.1/js/bootstrap-select.min.js"></script>

    <!--  Please do not delete below CSSes, important for pretty view -->
    <style>
        .go-datatable td {
            /*word-break: break-all;*/
        }

        table td {
            font-size: small;
        }

        /* Type, Dataset, RSE, Tier, C, RseKind */
        table tr td:nth-child(n+1):nth-child(-n+4) {
            text-align: left;
        }

        /* SizeBytes, LastAcc, LastAccMs, Fpct, Fcnt, TotFcnt, AccFcnt, ProdLckCnt, OthLckCnt */
        table tr td:nth-child(n+5):nth-child(-n+9) {
            text-align: right;
        }

        /*  */
        .table-striped > tbody > tr > td.rse-details-style {
            color: darkred;
        }

        .custom-input {
            /*height: 30px !important;*/
            /*max-height: 30px !important;*/
            /*background-color: gold;*/
        }

        .custom-filters {
            /*background-color: lightslategray;*/
            font-weight: bolder;
        }


    </style>
</head>
<body>

<div class="container-fluid no-padding" style="width: 100%">
    <div class="row" style="background-color: lightgray">
        <div class="col-xs-6 col-sm-4">
            <footer>
                <img alt="CERN CMS O&C" src="../static/img/oc_icon.png"
                     width="60"          height="40">
            </footer>
        </div>
        <div class="col-xs-6 col-sm-4 align-self-center">
            <h3> RUCIO DATASETS MONITORING </h3>
        </div>
        <div class="col-xs-6 col-sm-4 text-right">
            <footer>
                <img alt="CERN CMS O&C" src="../static/img/oc_icon.png" style="text-align: right;"
                     width="60"          height="40">
            </footer>
        </div>
    </div>
</div>

<div class="container-fluid no-padding" style="width: 96%">
    <div class="row">
        <hr class="rounded">
    </div>

    <div class="row custom-filters">
        <div class="col">
            <select class="selectpicker custom-input" id="select-rse-type" multiple title="RSE Type">
                <option value="DISK">DISK</option>
                <option value="TAPE">TAPE</option>
            </select>
        </div>
        <div class="col">
            <input class="form-control input-sm custom-input" id="search-dataset" placeholder="Dataset" type="search"/>
        </div>
        <div class="col">
            <input class="form-control input-sm custom-input" id="search-rse" placeholder="RSE" type="search"/>
        </div>
        <div class="col">
            <button class="btn btn-primary font-weight-bold" id="button-search" type="button">Search</button>
        </div>
    </div>

    <div class="row justify-content-md-center">
        <hr class="rounded">
    </div>
    <table class="go-datatable table table-sm table-bordered table-hover table-striped">
        <!-- table table-sm-->
        <thead class="thead-dark">
        <tr>
            <th>RseType</th>
            <th>Dataset</th>
            <th>LastAccess</th>
            <th>LastAccessMs</th>
            <th>MaxTB</th>
            <th>MinTB</th>
            <th>AvgTB</th>
            <th>SumTB</th>
            <th>RSEs</th>
        </tr>
        </thead>
        <tfoot hidden>
        <tr>
            <th>RseType</th>
            <th>Dataset</th>
            <th>LastAccess</th>
            <th>LastAccessMs</th>
            <th>MaxTB</th>
            <th>MinTB</th>
            <th>AvgTB</th>
            <th>SumTB</th>
            <th>RSEs</th>
        </tr>
        </tfoot>
    </table>
</div>

<!-- prepared using https://datatables.net/download/ -->
<script
    src="https://cdn.datatables.net/v/bs5/jq-3.6.0/jszip-2.5.0/dt-1.12.1/b-2.2.3/b-colvis-2.2.3/b-html5-2.2.3/b-print-2.2.3/date-1.1.2/fc-4.1.0/fh-3.2.4/r-2.3.0/sc-2.0.7/sb-1.3.4/sp-2.0.2/sl-1.4.0/sr-1.1.1/datatables.min.js">
</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/5.1.3/js/bootstrap.bundle.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.36/pdfmake.min.js" type="text/javascript"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.36/vfs_fonts.js" type="text/javascript"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/multiple-select/1.1.0/jquery.multiple.select.min.js"
        type="text/javascript">
</script>

<script>
    $(document).ready(function () {
        function toggleDetails() {
            var tr = $(this).closest("tr");
            dataset_name = $(tr).find("td.details-value-dataset").text()
            type_name = $(tr).find("td.details-value-type").text()
            random_str = Math.random().toString(36).slice(-10)
            d_class = "details-show"
            row = table.row(tr)
            if (!row.child.isShown()) {
                $(tr).addClass(d_class)
                row.child("<div id='" + type_name + random_str + "'>loading</div>").show()
                var single_dataset_request = {
                    "dataset": dataset_name,
                    "type": type_name
                }
                //console.log(JSON.stringify(single_dataset_request))
                $.ajax({
                    url: 'http://cmsweb-test1-zone-b-brkegglzfmze-node-1.cern.ch:31281/api/rse-detail',
                    type: 'post',
                    dataType: 'html',
                    contentType: 'application/json',
                    success: function (data) {
                        //$('#target').html(data.msg);
                        $("#" + type_name + random_str).html(data);
                    },
                    data: JSON.stringify(single_dataset_request),
                });
            } else {
                $(tr).removeClass(d_class)
                row.child.hide()
            }
        }

        var table = $('.go-datatable').DataTable({
            serverSide: true,
            processing: true,
            scrollX: false,
            pageLength: 10,
            order: [], // no initial sorting
            dom: "Brtpli", // no main search ("f"), just individual column search
            //language: {processing: '<i class="fa fa-spinner fa-spin fa-3x fa-fw"></i><span class="sr-only">Loading...</span> '},
            aLengthMenu: [
                [5, 10, 25, 50, 100],
                [5, 10, 25, 50, 100]
            ],

            ajax: {
                url: "http://cmsweb-test1-zone-b-brkegglzfmze-node-1.cern.ch:31281/api/datasets",
                method: "POST",
                contentType: 'application/json',
                data: function (d) {
                    // Customize search
                    // console.log("type:", $("#select-rse-type").val())
                    d.custom = {
                        "dataset": $("#search-dataset").val(),
                        "rse": $("#search-rse").val(),
                        "rseType": $("#select-rse-type").val(),
                    }
                    return JSON.stringify(d);
                },
                // processData: false,
                dataType: "json",
            },

            columns: [
                {data: "RseType", className: "details-value-type",},
                {
                    data: "Dataset",
                    className: "details-value-dataset",
                    render: function (data, type, row, meta) {
                        return '<a href="javascript:void(0);" class="btn-details">' + data + '</a>';
                    }
                },
                {data: "LastAccess"},
                {data: "LastAccessMs"},
                {data: "MaxTB"},
                {data: "MinTB"},
                {data: "AvgTB"},
                {data: "SumTB"},
                {data: "RSEs", className: "rse-details-style"}
            ]
        });
        // ~~  --  Custom search draw  -- ~~
        $('#button-search').click(function () {
            table.draw();
        });
        $('table tbody tr').on('click', 'td a.btn-details', toggleDetails)
        //
        table.on('draw', function () {
            $('table tbody tr').off('click').on('click', 'td a.btn-details', toggleDetails)
        })
    });
</script>
</body>
</html>
